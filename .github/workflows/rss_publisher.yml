name: Publish RSS to Instagram

on:
  schedule:
    # ExÃ©cute tous les jours Ã  8h00 UTC
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies and jq ðŸ”§
        run: |
          # Installation de jq (pour la validation JSON) et les dÃ©pendances Python
          sudo apt-get update && sudo apt-get install -y jq
          
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python Script with Imagen Authentication FIX ðŸ”‘
        # Cette Ã©tape rÃ©sout le problÃ¨me de formatage JSON (parse error)
        run: |
          echo "--- PrÃ©paration des identifiants Vertex AI (ADC) ---"
          
          CREDENTIALS_FILE="$GITHUB_WORKSPACE/gcp_sa_key.json"
          
          # 1. Ã‰crire le secret JSON multiligne dans le fichier.
          # L'utilisation de 'cat <<EOF' est la mÃ©thode la plus fiable pour les clÃ©s multilignes
          # car elle prÃ©serve la structure exacte du JSON, y compris les sauts de ligne.
          cat > $CREDENTIALS_FILE <<EOF
          ${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}
          EOF
          
          # 2. VÃ©rification de la validitÃ© JSON (le 'jq -e .' garantit que le fichier est valide)
          echo "VÃ©rification de la validitÃ© JSON..."
          jq -e . $CREDENTIALS_FILE
          
          # 3. DÃ©finir la variable d'environnement GOOGLE_APPLICATION_CREDENTIALS
          # C'est ce qui permet Ã  la librairie google-cloud-aiplatform de s'authentifier
          export GOOGLE_APPLICATION_CREDENTIALS=$CREDENTIALS_FILE
          
          echo "âœ… Identifiants chargÃ©s pour l'API Google Cloud."
          
          # 4. ExÃ©cuter le script
          python rss_publisher.py
        
        env:
          # Assurez-vous que tous vos secrets sont listÃ©s ici
          FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          FB_ACCESS_TOKEN: ${{ secrets.FB_ACCESS_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GCS_SERVICE_ACCOUNT_KEY: ${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}
