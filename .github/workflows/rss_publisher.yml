# .github/workflows/rss_publisher.yml (ou main.yml)

name: Publish RSS to Instagram

on:
  schedule:
    # Ex√©cute tous les jours √† 8h00 UTC (ajustez l'heure selon votre besoin)
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Assurez-vous que toutes les d√©pendances, y compris google-cloud-aiplatform, sont dans requirements.txt
          pip install -r requirements.txt

      - name: Run Python Script with Imagen Authentication FIX üîë
        # Cette √©tape utilise un script shell pour r√©soudre l'erreur ADC
        run: |
          echo "--- Pr√©paration des identifiants Vertex AI (ADC) ---"
          
          # 1. Cr√©er le fichier credentials.json √† partir du secret GCS_SERVICE_ACCOUNT_KEY
          # La variable $GITHUB_WORKSPACE est le r√©pertoire racine du projet
          CREDENTIALS_FILE="$GITHUB_WORKSPACE/gcp_sa_key.json"
          echo "${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}" > $CREDENTIALS_FILE
          
          # 2. D√©finir la variable d'environnement GOOGLE_APPLICATION_CREDENTIALS
          # C'est ce qui permet √† la librairie google-cloud-aiplatform (Imagen) de s'authentifier
          export GOOGLE_APPLICATION_CREDENTIALS=$CREDENTIALS_FILE
          
          echo "‚úÖ Identifiants charg√©s pour l'API Google Cloud."
          
          # 3. Ex√©cuter le script
          python rss_publisher.py
        
        env:
          # ATTENTION : Remplacez les placeholders ci-dessous par VOS NOMS de secrets
          FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          FB_ACCESS_TOKEN: ${{ secrets.FB_ACCESS_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GCS_SERVICE_ACCOUNT_KEY: ${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}
