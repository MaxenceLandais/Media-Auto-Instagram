name: Publish RSS to Instagram

on:
  schedule:
    # Ex√©cute tous les jours √† 8h00 UTC
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies and jq üîß
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # NOTE IMPORTANTE : La logique d'√©criture de la cl√© JSON sur le disque
      # et la d√©finition de GOOGLE_APPLICATION_CREDENTIALS sont MODIFI√âES.
      # Le script Python d√©code GCS_SERVICE_ACCOUNT_KEY en Base64 et l'utilise
      # directement pour 'google.cloud.storage.Client.from_service_account_info'.
      # La librairie 'google.cloud.aiplatform' s'initialise avec project_id et location
      # et utilise les variables d'environnement Google standard (ADC) si elles sont configur√©es.
      # Pour simplifier, nous passons la cl√© encod√©e en base64 directement.
      - name: Run Python Script üöÄ
        run: |
          # Ex√©cute le script principal. Les cl√©s sont pass√©es via les variables d'environnement.
          # Le script Python est maintenant responsable du d√©codage de GCS_SERVICE_ACCOUNT_KEY.
          python rss_publisher.py
        env:
          FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          FB_ACCESS_TOKEN: ${{ secrets.FB_ACCESS_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # Passez GCS_SERVICE_ACCOUNT_KEY directement, le script Python le d√©codera.
          GCS_SERVICE_ACCOUNT_KEY: ${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}

      # Optionnel : Si vous voulez que les images g√©n√©r√©es soient conserv√©es comme artefacts
      # - name: Upload generated images as artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: generated-images
      #     path: generated_images/
