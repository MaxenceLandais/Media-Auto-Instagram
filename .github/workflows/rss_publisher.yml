name: Publish RSS to Instagram

on:
  schedule:
    # Ex√©cute tous les jours √† 8h00 UTC (√† ajuster)
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies and jq üîß
        run: |
          # Installation de jq, l'outil n√©cessaire pour nettoyer le secret JSON
          sudo apt-get update && sudo apt-get install -y jq
          
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python Script with Imagen Authentication FIX üîë
        # Cette √©tape garantit que le secret est un JSON propre pour l'ADC
        run: |
          echo "--- Pr√©paration des identifiants Vertex AI (ADC) ---"
          
          # 1. Nettoyer et cr√©er le fichier JSON
          # Utilisation de 'jq -r .' pour s'assurer que le secret est un JSON valide et sans guillemets ou espaces inutiles.
          CREDENTIALS_FILE="$GITHUB_WORKSPACE/gcp_sa_key.json"
          echo "${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}" | jq -r '.' > $CREDENTIALS_FILE
          
          # 2. D√©finir la variable d'environnement GOOGLE_APPLICATION_CREDENTIALS
          export GOOGLE_APPLICATION_CREDENTIALS=$CREDENTIALS_FILE
          
          echo "‚úÖ Identifiants charg√©s pour l'API Google Cloud."
          
          # 3. Ex√©cuter le script
          python rss_publisher.py
        
        env:
          # Assurez-vous que tous vos secrets sont list√©s ici
          FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          FB_ACCESS_TOKEN: ${{ secrets.FB_ACCESS_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GCS_SERVICE_ACCOUNT_KEY: ${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}
