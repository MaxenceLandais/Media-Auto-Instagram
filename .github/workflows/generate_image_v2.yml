name: Generate Image to GCS

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install google-cloud-aiplatform google-cloud-storage

    - name: Set up Google Cloud Authentication
      run: |
        echo '${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}' > gcp_sa_key.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=$GITHUB_WORKSPACE/gcp_sa_key.json" >> $GITHUB_ENV
        
    - name: Run Image Generation
      run: python generate_image_v2.py

    - name: Cleanup
      if: always()
      run: rm -f gcp_sa_key.json
